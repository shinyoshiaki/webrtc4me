(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{214:function(e,t,n){e.exports=n(361)},243:function(e,t){},247:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n(1),i=a.__importDefault(n(91)),r=a.__importDefault(n(92));!function(e){e[e.video=0]="video",e[e.audio=1]="audio"}(t.MediaType||(t.MediaType={}));var o=function(){function e(e,t){void 0===t&&(t={}),this.peer=e,this.opt=t,this.onStream=new r.default,this.onLocalStream=new r.default,this.initDone=!1,this.label=t.label||"stream",this.listen()}return e.prototype.listen=function(){return a.__awaiter(this,void 0,void 0,function(){var e,t,n,i,r,o,c,s=this;return a.__generator(this,function(a){switch(a.label){case 0:return e="init_"+this.label,t=this.opt,n=t.get,i=t.stream,r=t.immidiate,o=t.track,c=i,r?(this.init({stream:c,track:o}),[3,4]):[3,1];case 1:return n?[4,n.catch(console.log)]:[3,3];case 2:c=a.sent(),this.onLocalStream.execute(c),a.label=3;case 3:this.peer.onData.once(function(t){t.label===e&&"done"===t.data&&(n||s.init({stream:c,track:o}))}),this.peer.send("done",e),a.label=4;case 4:return[2]}})})},e.prototype.init=function(e){return a.__awaiter(this,void 0,void 0,function(){var t,n,r,o,c=this;return a.__generator(this,function(a){return t=e.stream,n=e.track,this.initDone?[2]:(this.initDone=!0,r=this.peer,o=new i.default({stream:t,track:n}),r.isOffer?(o.makeOffer(),o.onSignal.once(function(e){r.send(JSON.stringify(e),c.label+"_offer")}),r.onData.once(function(e){e.label===c.label+"_answer"&&o.setSdp(JSON.parse(e.data))})):r.onData.once(function(e){e.label===c.label+"_offer"&&(o.setSdp(JSON.parse(e.data)),o.onSignal.once(function(e){r.send(JSON.stringify(e),c.label+"_answer")}))}),o.onAddTrack.once(function(e){c.onStream.execute(e)}),[2])})})},e}();t.default=o},248:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n(360),i=16e3;function r(e){var t=new a.Subject,n=t.asObservable(),r=new FileReader,o=File.prototype.slice,c=Math.ceil(e.size/i),s=0;function u(){var t=s*i,n=t+i>=e.size?e.size:t+i;r.readAsArrayBuffer(o.call(e,t,n))}return r.onerror=function(e){t.error(e)},r.onload=function(e){var n=e.target.result;++s<c?(u(),t.next(n)):t.complete()},u(),n}t.getSliceArrayBuffer=r;var o=function(){function e(e,t){var n=this;this.peer=e,this.label=t,this.subject=new a.Subject,this.state=this.subject.asObservable(),this.chunks=[],this.name="",this.size=0,t||(t="file"),console.log({label:t}),e.onData.subscribe(function(t){var a=t.label,r=t.data;if(a===n.label)try{var o=JSON.parse(r);switch(o.state){case"start":n.chunks=[],n.name=o.name,n.size=o.size;break;case"end":n.subject.next({type:"downloaded",payload:{chunks:n.chunks,name:n.name}}),e.send(JSON.stringify({state:"complete",name:n.name}),n.label),n.chunks=[],n.name=""}}catch(c){n.chunks.push(r),n.subject.next({type:"downloading",payload:{now:n.chunks.length*i,size:n.size}})}})}return e.prototype.sendStart=function(e,t){this.name=e,this.peer.send(JSON.stringify({state:"start",size:t,name:e}),this.label)},e.prototype.sendChunk=function(e){this.peer.send(e,this.label)},e.prototype.sendEnd=function(){this.peer.send(JSON.stringify({state:"end"}),this.label)},e.prototype.send=function(e){var t=this;this.sendStart(e.name,e.size),r(e).subscribe(function(e){return t.sendChunk(e)},function(){},function(){t.sendEnd()})},e}();t.default=o},361:function(e,t,n){"use strict";n.r(t);var a=n(2),i=n.n(a),r=n(16),o=n.n(r),c=n(19),s=n.n(c),u=n(43),l=n(28),d=n(125),h=n.n(d),f=n(77),p=n.n(f),g=h.a.connect("https://aqueous-earth-75182.herokuapp.com/");function v(e,t){return new Promise(function(n){var a=new p.a({nodeId:"answer",trickle:t});g.emit("create",{roomId:e}),g.on("sdp",function(e){console.log({data:e}),a.setSdp(e.sdp)});var i=a.onSignal.subscribe(function(t){console.log({sdp:t,roomId:e}),g.emit("sdp",{sdp:t,roomId:e})});a.onConnect.once(function(){console.log("connect"),i.unSubscribe(),n(a)}),a.onData.subscribe(function(e){console.log({message:e})})})}function m(e,t){return new Promise(function(n){var a=new p.a({nodeId:"offer",trickle:t});g.emit("join",{roomId:e}),g.on("join",function(){a.makeOffer()}),g.on("sdp",function(e){console.log({data:e}),a.setSdp(e.sdp)});var i=a.onSignal.subscribe(function(t){console.log({sdp:t,roomId:e}),g.emit("sdp",{sdp:t,roomId:e})});a.onConnect.once(function(){console.log("connect"),n(a),i.unSubscribe()}),a.onData.subscribe(function(e){console.log({message:e})})})}var b=n(126),w=n(76),_=function(){var e=Object(a.useState)(""),t=Object(l.a)(e,2),n=t[0],r=t[1],o=Object(a.useState)(""),c=Object(l.a)(o,2),d=c[0],h=c[1],f=Object(a.useState)(!1),p=Object(l.a)(f,2),g=p[0],_=p[1],y=Object(a.useState)(void 0),k=Object(l.a)(y,2),S=k[0],O=k[1],C=Object(a.useState)(""),D=Object(l.a)(C,2),j=D[0],T=D[1],E=Object(a.useRef)(void 0);Object(a.useEffect)(function(){S&&S.onData.subscribe(function(e){"share"===e.label&&T(e.data)})},[S]);var x=function(){var e=Object(u.a)(s.a.mark(function e(t){var n;return s.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.onAddTrack.subscribe(function(e){E&&(E.current.srcObject=e)}),e.next=3,Object(w.getLocalVideo)();case 3:n=e.sent,t.isOffer?t.addTrack(n.getVideoTracks()[0],n):setTimeout(function(){t.addTrack(n.getVideoTracks()[0],n)},2e3);case 5:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}();return i.a.createElement("div",null,i.a.createElement("p",null,"webrtc"),i.a.createElement("div",null,"trickle",i.a.createElement("br",null),i.a.createElement("input",{type:"radio",checked:!g,onChange:function(){return _(!g)}}),"off",i.a.createElement("input",{type:"radio",checked:g,onChange:function(){return _(!g)}}),"on"),i.a.createElement("br",null),i.a.createElement("input",{onChange:function(e){r(e.target.value)},placeholder:"roomId",value:n}),i.a.createElement("button",{onClick:Object(u.a)(s.a.mark(function e(){var t;return s.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("create"),h("room:"+n+" create"),r(""),e.next=5,v(n,g);case 5:t=e.sent,O(t),x(t);case 8:case"end":return e.stop()}},e)}))},"create"),i.a.createElement("button",{onClick:Object(u.a)(s.a.mark(function e(){var t;return s.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("join"),h("room:"+n+" join"),r(""),e.next=5,m(n,g);case 5:t=e.sent,O(t),x(t);case 8:case"end":return e.stop()}},e)}))},"join"),i.a.createElement("br",null),i.a.createElement("p",null,d),i.a.createElement("video",{ref:E,autoPlay:!0,style:{width:"100%",height:"100%"}}),i.a.createElement("p",null,"datachannel"),i.a.createElement(b.a,{multiline:!0,value:j,onChange:function(e){T(e.target.value),S&&S.send(e.target.value,"share")},style:{width:"40vw"}}))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(i.a.createElement(_,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})},76:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLocalVideo=function(e){return new Promise(function(t){navigator.mediaDevices.getUserMedia({audio:!0,video:e||!0}).then(function(e){t(e)})})},t.getLocalAudio=function(){return new Promise(function(e){navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(t){e(t)})})},t.getLocalDesktop=function(e){return new Promise(function(t){navigator.mediaDevices.getDisplayMedia({video:e||!0}).then(function(e){t(e)})})}},77:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n(1),i=a.__importDefault(n(91)),r=a.__importDefault(n(247));t.Stream=r.default;var o=a.__importDefault(n(248));t.FileShare=o.default;var c=a.__importStar(n(76));t.Utill=c,t.default=i.default},91:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n(1),i=n(246),r=a.__importDefault(n(92)),o=function(){function e(e){var t=this;void 0===e&&(e={}),this.opt=e,this.onSignal=new r.default,this.onConnect=new r.default,this.onDisconnect=new r.default,this.onData=new r.default,this.onAddTrack=new r.default,this.isConnected=!1,this.isDisconnected=!1,this.isOffer=!1,this.negotiating=!1;var n=e.nodeId,a=e.stream,i=e.track;this.dataChannels={},this.nodeId=n||"peer",this.rtc=this.prepareNewConnection(),a?a.getTracks().forEach(function(e){return t.rtc.addTrack(e,a)}):i&&this.rtc.addTrack(i)}return e.prototype.prepareNewConnection=function(){var e=this,t=this.opt,n=t.disable_stun,a=t.trickle,r=n?new i.RTCPeerConnection({iceServers:[]}):new i.RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});return r.ontrack=function(t){var n=t.streams[0];e.onAddTrack.execute(n),e.remoteStream=n},r.oniceconnectionstatechange=function(){switch(r.iceConnectionState){case"failed":break;case"disconnected":try{e.timeoutPing=setTimeout(function(){e.hangUp()},2e3),e.send("ping","live")}catch(t){console.warn({error:t})}break;case"connected":e.timeoutPing&&clearTimeout(e.timeoutPing)}},r.onicecandidate=function(t){e.isConnected||(t.candidate?a&&e.onSignal.execute({type:"candidate",ice:t.candidate}):!a&&r.localDescription&&e.onSignal.execute(r.localDescription))},r.ondatachannel=function(t){var n=t.channel;e.dataChannels[n.label]=n,e.dataChannelEvents(n)},r.onsignalingstatechange=function(t){e.negotiating="stable"!=r.signalingState},r},e.prototype.hangUp=function(){this.isDisconnected=!0,this.isConnected=!1,this.onDisconnect.execute()},e.prototype.makeOffer=function(){var e=this;this.isOffer=!0;var t=this.opt.trickle;this.createDatachannel("datachannel"),this.rtc.onnegotiationneeded=function(){return a.__awaiter(e,void 0,void 0,function(){var e,n;return a.__generator(this,function(a){switch(a.label){case 0:return this.negotiating||"stable"!=this.rtc.signalingState?[2]:(this.negotiating=!0,[4,this.rtc.createOffer().catch(console.warn)]);case 1:return(e=a.sent())?[4,this.rtc.setLocalDescription(e).catch(function(e){return JSON.stringify(e)+"err"})]:[2];case 2:return"string"===typeof a.sent()?[2]:(n=this.rtc.localDescription,t&&n&&this.onSignal.execute(n),this.negotiation(),[2])}})})}},e.prototype.negotiation=function(){var e=this;this.rtc.onnegotiationneeded=function(){return a.__awaiter(e,void 0,void 0,function(){var e,t,n;return a.__generator(this,function(a){switch(a.label){case 0:if(!this.isConnected)return[2];a.label=1;case 1:return a.trys.push([1,,4,5]),this.negotiating||"stable"!=this.rtc.signalingState?[2]:(this.negotiating=!0,e={},[4,this.rtc.createOffer(e).catch()]);case 2:return t=a.sent(),[4,this.rtc.setLocalDescription(t).catch()];case 3:return a.sent(),(n=this.rtc.localDescription)&&this.send(JSON.stringify(n),"update"),[3,5];case 4:return this.negotiating=!1,[7];case 5:return[2]}})})}},e.prototype.setAnswer=function(e){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(t){switch(t.label){case 0:return this.isOffer?[4,this.rtc.setRemoteDescription(new i.RTCSessionDescription(e)).catch(console.warn)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},e.prototype.makeAnswer=function(e){return a.__awaiter(this,void 0,void 0,function(){var t,n,r;return a.__generator(this,function(a){switch(a.label){case 0:return t=this.opt.trickle,[4,this.rtc.setRemoteDescription(new i.RTCSessionDescription(e)).catch(console.warn)];case 1:return a.sent(),[4,this.rtc.createAnswer().catch(console.warn)];case 2:return(n=a.sent())?[4,this.rtc.setLocalDescription(n).catch(console.warn)]:(console.warn("no answer"),[2]);case 3:return a.sent(),r=this.rtc.localDescription,this.isConnected?this.send(JSON.stringify(r),"update"):t&&r&&this.onSignal.execute(r),this.negotiation(),[2]}})})},e.prototype.setSdp=function(e){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(t){switch(t.label){case 0:switch(e.type){case"offer":return[3,1];case"answer":return[3,2];case"candidate":return[3,3]}return[3,5];case 1:return this.makeAnswer(e),[3,5];case 2:return this.setAnswer(e),[3,5];case 3:return[4,this.rtc.addIceCandidate(new i.RTCIceCandidate(e.ice)).catch(console.warn)];case 4:return t.sent(),[3,5];case 5:return[2]}})})},e.prototype.createDatachannel=function(e){return a.__awaiter(this,void 0,void 0,function(){var t,n;return a.__generator(this,function(a){switch(a.label){case 0:if(Object.keys(this.dataChannels).includes(e))return[3,4];a.label=1;case 1:return a.trys.push([1,3,,4]),t=this.rtc.createDataChannel(e),this.dataChannels[e]=t,[4,this.dataChannelEvents(t)];case 2:return a.sent(),[3,4];case 3:return n=a.sent(),console.error(n),[3,4];case 4:return[2]}})})},e.prototype.dataChannelEvents=function(e){var t=this;return new Promise(function(n){e.onopen=function(){t.isConnected||(t.isConnected=!0,t.onConnect.execute()),n()},e.onmessage=function(n){return a.__awaiter(t,void 0,void 0,function(){var t;return a.__generator(this,function(a){if(!n)return[2];try{"update"===e.label?(t=JSON.parse(n.data),this.setSdp(t)):"live"===e.label?"ping"===n.data?this.send("pong","live"):this.timeoutPing&&clearTimeout(this.timeoutPing):this.onData.execute({label:e.label,data:n.data,nodeId:this.nodeId})}catch(i){console.warn(i)}return[2]})})},e.onerror=function(e){return console.warn(e)},e.onclose=function(){}})},e.prototype.send=function(e,t){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(n){switch(n.label){case 0:return t=t||"datachannel",Object.keys(this.dataChannels).includes(t)?[3,2]:[4,this.createDatachannel(t)];case 1:n.sent(),n.label=2;case 2:try{this.dataChannels[t].send(e)}catch(a){console.warn(a)}return[2]}})})},e.prototype.addTrack=function(e,t){this.rtc.addTrack(e,t)},e.prototype.disconnect=function(){return a.__awaiter(this,void 0,void 0,function(){var e,t,n,i,r;return a.__generator(this,function(a){switch(a.label){case 0:for(i in t=(e=this).rtc,n=e.dataChannels)(r=n[i]).onmessage=null,r.onopen=null,r.onclose=null,r.onerror=null,r.close();return this.dataChannels=null,t.oniceconnectionstatechange=null,t.onicegatheringstatechange=null,t.onsignalingstatechange=null,t.onicecandidate=null,t.ontrack=null,t.ondatachannel=null,t.close(),this.rtc=null,[4,new Promise(function(e){return setTimeout(e,3e4)})];case 1:return a.sent(),[2]}})})},e}();t.default=o}},[[214,1,2]]]);
//# sourceMappingURL=main.3a8ca3eb.chunk.js.map