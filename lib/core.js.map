{"version":3,"file":"core.js","sourceRoot":"","sources":["../src/core.ts"],"names":[],"mappings":"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","sourcesContent":["import { Pack, Wait } from \"rx.mini\";\nimport ArrayBufferService from \"./services/arraybuffer\";\n\nexport type Message = {\n  label: string | \"datachannel\";\n  data: string | ArrayBuffer;\n  nodeId: string;\n};\n\nexport type Signal = {\n  type: \"candidate\" | \"offer\" | \"answer\" | \"pranswer\" | \"rollback\";\n  ice?: RTCIceCandidateInit;\n  sdp?: string;\n};\n\ntype Option = {\n  disable_stun: boolean;\n  stream: MediaStream;\n  track: MediaStreamTrack;\n  nodeId: string;\n  trickle: boolean;\n  wrtc: any;\n};\n\nlet { RTCPeerConnection, RTCSessionDescription, RTCIceCandidate } = (() => {\n  try {\n    return window;\n  } catch (error) {\n    return {} as any;\n  }\n})();\n\nexport default class WebRTC {\n  rtc: RTCPeerConnection;\n\n  private pack = Pack();\n  private event = this.pack.event;\n\n  onSignal = this.event<Signal>();\n  onConnect = this.event<undefined>();\n  onDisconnect = this.event<undefined>();\n  onData = this.event<Message>();\n  onAddTrack = this.event<MediaStream>();\n  onOpenDC = this.event<RTCDataChannel>();\n\n  private wait4DC = new Wait<RTCDataChannel | undefined>();\n\n  private dataChannels: { [key: string]: RTCDataChannel } = {};\n\n  nodeId: string;\n\n  isConnected = false;\n  isDisconnected = false;\n  isOffer = false;\n  isNegotiating = false;\n\n  remoteStream: MediaStream | undefined;\n  private timeoutPing: any | undefined;\n\n  private arrayBufferService = new ArrayBufferService(this);\n\n  constructor(public opt: Partial<Option> = {}) {\n    const { nodeId, stream, track, wrtc } = opt;\n\n    if (wrtc) {\n      RTCPeerConnection = wrtc.RTCPeerConnection;\n      RTCSessionDescription = wrtc.RTCSessionDescription;\n      RTCIceCandidate = wrtc.RTCIceCandidate;\n    }\n\n    this.nodeId = nodeId || \"peer\";\n\n    this.rtc = this.prepareNewConnection();\n\n    if (stream) {\n      stream.getTracks().forEach(track => this.rtc.addTrack(track, stream));\n    } else if (track) {\n      this.rtc.addTrack(track);\n    }\n  }\n\n  private prepareNewConnection() {\n    const { disable_stun, trickle } = this.opt;\n    const peer = new RTCPeerConnection({\n      iceServers: disable_stun\n        ? []\n        : [\n            {\n              urls: \"stun:stun.l.google.com:19302\"\n            }\n          ]\n    }) as RTCPeerConnection;\n\n    peer.ontrack = evt => {\n      const stream = evt.streams[0];\n      this.onAddTrack.execute(stream);\n      this.remoteStream = stream;\n    };\n\n    peer.oniceconnectionstatechange = () => {\n      switch (peer.iceConnectionState) {\n        case \"failed\":\n          break;\n        case \"disconnected\":\n          if (this.rtc) {\n            this.timeoutPing = setTimeout(() => {\n              this.hangUp();\n            }, 1000);\n            try {\n              this.send(\"ping\", \"live\");\n            } catch (error) {\n              console.warn(\"disconnected\", { error });\n            }\n          }\n          break;\n        case \"connected\":\n          if (this.timeoutPing) clearTimeout(this.timeoutPing);\n          break;\n        case \"closed\":\n          break;\n        case \"completed\":\n          break;\n      }\n    };\n\n    peer.onicecandidate = ({ candidate }) => {\n      if (!this.isConnected) {\n        if (candidate) {\n          if (trickle) {\n            this.onSignal.execute({\n              type: \"candidate\",\n              ice: JSON.parse(JSON.stringify(candidate))\n            });\n          }\n        } else {\n          if (!trickle && peer.localDescription) {\n            this.onSignal.execute(peer.localDescription);\n          }\n        }\n      }\n    };\n\n    peer.ondatachannel = ({ channel }) => {\n      this.dataChannels[channel.label] = channel;\n      this.dataChannelEvents(channel);\n      this.onOpenDC.execute(channel);\n    };\n\n    peer.onsignalingstatechange = () => {\n      this.isNegotiating = peer.signalingState != \"stable\";\n    };\n\n    return peer;\n  }\n\n  hangUp() {\n    this.isDisconnected = true;\n    this.isConnected = false;\n    this.onDisconnect.execute(undefined);\n    this.disconnect();\n  }\n\n  makeOffer() {\n    this.isOffer = true;\n    const { trickle } = this.opt;\n\n    this.createDatachannel(\"datachannel\");\n\n    this.rtc.onnegotiationneeded = async () => {\n      if (this.isNegotiating || this.rtc.signalingState != \"stable\") {\n        console.warn(\"already negotiating\");\n        return;\n      }\n\n      this.isNegotiating = true;\n\n      const sdp = await this.rtc.createOffer().catch(console.warn);\n      if (!sdp) return;\n\n      const err = await this.rtc.setLocalDescription(sdp).catch(() => \"err\");\n      if (err) return;\n\n      const local = this.rtc.localDescription;\n\n      if (trickle && local) {\n        this.onSignal.execute(local);\n      }\n\n      this.updateNegotiation();\n    };\n  }\n\n  private updateNegotiation() {\n    this.rtc.onnegotiationneeded = async () => {\n      if (!this.isConnected) return;\n      if (this.isNegotiating || this.rtc.signalingState != \"stable\") {\n        console.warn(\"already negotiating\");\n        return;\n      }\n\n      this.isNegotiating = true;\n\n      const sdp = await this.rtc.createOffer().catch(console.warn);\n      if (!sdp) return;\n\n      const err = await this.rtc.setLocalDescription(sdp).catch(() => \"err\");\n      if (err) return;\n\n      const local = this.rtc.localDescription;\n      if (local) this.send(JSON.stringify(local), \"update\");\n\n      this.isNegotiating = false;\n    };\n  }\n\n  private async setAnswer(sdp: Signal) {\n    await this.rtc\n      .setRemoteDescription(new RTCSessionDescription(sdp))\n      .catch(console.warn);\n  }\n\n  private async makeAnswer(offer: Signal) {\n    const { trickle } = this.opt;\n\n    {\n      const err = await this.rtc\n        .setRemoteDescription(new RTCSessionDescription(offer))\n        .catch(() => \"err\");\n      if (err) return err;\n    }\n\n    const answer = await this.rtc.createAnswer().catch(console.warn);\n    if (!answer) return \"err\";\n\n    {\n      const err = await this.rtc.setLocalDescription(answer).catch(() => \"err\");\n      if (err) return err;\n    }\n\n    const local = this.rtc.localDescription;\n    if (!local) return \"err\";\n\n    if (this.isConnected) this.send(JSON.stringify(local), \"update\");\n    else if (trickle) this.onSignal.execute(local);\n\n    this.updateNegotiation();\n  }\n\n  async setSdp(sdp: Signal) {\n    switch (sdp.type) {\n      case \"offer\":\n        const err = await this.makeAnswer(sdp);\n        err && console.warn(err);\n        break;\n      case \"answer\":\n        this.setAnswer(sdp);\n        break;\n      case \"candidate\":\n        await this.rtc\n          .addIceCandidate(new RTCIceCandidate(sdp.ice))\n          .catch(console.warn);\n        break;\n    }\n  }\n\n  private isDCOpend = (label: string) => {\n    const dc = this.dataChannels[label];\n    if (!dc) return false;\n    return dc.readyState === \"open\";\n  };\n\n  private async createDatachannel(label: string) {\n    const wait = async () => {\n      try {\n        const dc = this.rtc.createDataChannel(label);\n        await this.dataChannelEvents(dc);\n        if (dc.readyState === \"open\") return dc;\n      } catch (dce) {\n        console.error(dce);\n      }\n    };\n\n    if (!this.isDCOpend(label)) {\n      const { exist, result } = await this.wait4DC.create(label, wait);\n\n      if (exist) {\n        const res = await exist.asPromise().catch(() => {});\n        if (res) this.dataChannels[label] = res;\n      }\n      if (result) {\n        this.dataChannels[label] = result;\n      }\n    }\n  }\n\n  private dataChannelEvents = (channel: RTCDataChannel) =>\n    new Promise(resolve => {\n      channel.onopen = () => {\n        if (!this.isConnected) {\n          this.isConnected = true;\n          this.onConnect.execute(undefined);\n        }\n        resolve();\n      };\n\n      channel.onmessage = async ({ data }) => {\n        try {\n          if (channel.label === \"update\") {\n            const sdp = JSON.parse(data);\n            this.setSdp(sdp);\n          } else if (channel.label === \"live\") {\n            if (data === \"ping\") this.send(\"pong\", \"live\");\n            else if (this.timeoutPing) clearTimeout(this.timeoutPing);\n          } else {\n            if (typeof data === \"string\") {\n              try {\n                const check = JSON.parse(data);\n                if (check.it87nc247 === \"json\") {\n                  data = check.payload;\n                }\n              } catch (error) {}\n            }\n\n            this.onData.execute({\n              label: channel.label as string | \"datachannel\",\n              data,\n              nodeId: this.nodeId\n            });\n          }\n        } catch (error) {\n          console.warn(error);\n        }\n      };\n\n      channel.onerror = err => console.warn(err);\n      channel.onclose = () => delete this.dataChannels[channel.label];\n    });\n\n  async send(data: string | ArrayBuffer | Buffer, label = \"datachannel\") {\n    if (!this.rtc) return;\n    const { arrayBufferService } = this;\n    const sendData = async () => {\n      try {\n        if (typeof data === \"string\") {\n          const err = await this.createDatachannel(label).catch(() => \"error\");\n          if (err) {\n            console.warn({ err });\n            return err;\n          }\n          this.dataChannels[label].send(data);\n        } else {\n          if (data.byteLength > 16000) {\n            await arrayBufferService.send(data, label);\n          } else {\n            const err = await this.createDatachannel(label).catch(\n              () => \"error\"\n            );\n            if (err) return err;\n            this.dataChannels[label].send(data);\n          }\n        }\n      } catch (error) {\n        return \"unhandle datachannel error\";\n      }\n    };\n\n    const err = await sendData();\n    if (err) {\n      console.warn(\"retry send data channel\");\n      await new Promise(r => setTimeout(r));\n      const error = await sendData();\n      console.warn(\"fail\", error);\n    }\n  }\n\n  async sendJson(payload: object, label = \"datachannel\") {\n    if (!this.rtc) return;\n    const err = await this.createDatachannel(label).catch(() => \"error\");\n    if (err) {\n      console.warn({ err });\n      return err;\n    }\n    this.dataChannels[label].send(\n      JSON.stringify({ it87nc247: \"json\", payload })\n    );\n  }\n\n  addTrack(track: MediaStreamTrack, stream: MediaStream) {\n    this.rtc.addTrack(track, stream);\n  }\n\n  private disconnect() {\n    const { rtc, dataChannels } = this;\n\n    if (!rtc) return;\n\n    for (let key in dataChannels) {\n      const channel = dataChannels[key];\n      channel.onmessage = null as any;\n      channel.onopen = null as any;\n      channel.onclose = null as any;\n      channel.onerror = null as any;\n      channel.close();\n    }\n\n    rtc.oniceconnectionstatechange = null as any;\n    rtc.onicegatheringstatechange = null as any;\n    rtc.onsignalingstatechange = null as any;\n    rtc.onicecandidate = null as any;\n    rtc.ontrack = null as any;\n    rtc.ondatachannel = null as any;\n    rtc.close();\n\n    this.rtc = null as any;\n\n    this.pack.finishAll();\n  }\n}\n"]}